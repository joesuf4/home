# -*- sh -*-

export EKS_CLUSTERS_SRC EKS_PODS_SRC EKS_BATCH=4
declare -a _eks_clusters _eks_pods
declare -ar _eks_tools=(htop lsof strace curl)

eks_list_clusters_filter() {
  local FILTER="${1-}"
  for c in "${_eks_clusters[@]}"; do echo "$c"; done | grep -Pe "$FILTER"
}

eks_list_pods_filter() {
  local FILTER="${1-}"
  for c in "${_eks_pods[@]}"; do echo "$c"; done | grep -Pe "$FILTER"
}

_eks_load_clusters() {
  [ -n "$BCS_PROFILE" ] || return 0
  : "${EKS_CLUSTERS_SRC:=$(aws eks list-clusters --output text | awk '{print $2}')}"
  eval "_eks_clusters=($EKS_CLUSTERS_SRC)"
  EKS_PODS_SRC=
  return 0
}

_eks_load_pods() {
  [ -n "$BCS_PROFILE" ] || return 0
  : "${EKS_PODS_SRC:=$(kubectl get pods | (
    read -r _
    awk '{print $1}'
  ))}"
  eval "_eks_pods=($EKS_PODS_SRC)"
  return 0
}

eks_update_kubeconfig() {
  aws eks update-kubeconfig --name "$1"
  EKS_PODS_SRC=
  _eks_load_pods
}

eks_ship_tools_filter_bg() {
  local FILTER="${1-}"
  local container="${2---}"
  [[ "$container" == "--" ]] && container=""

  for pod in $(eks_list_pods_filter "$FILTER"); do
    [ -n "$container" ] && pod+=" -c"
    for t in "${_eks_tools[@]}"; do
      time kubectl exec -i $pod $container -- sh -c "mkdir -p /tmp/bin && cat >/tmp/bin/$t && chmod +x /tmp/bin/$t" <~/bin/$t &
    done
    kubectl exec --logtostderr $pod $container -- sh -c 'echo PATH="$PATH:/tmp/bin" > ~/.profile' &
  done

  wait
}

eks_send_bpftrace_kheaders_filter_bg() {
  local FILTER="${1-}"
  local container="${2---}"

  [[ "$container" == "--" ]] && container=""

  for pod in $(eks_list_pods_filter "$FILTER"); do
    [[ -n "$container" ]] && pod+=" -c"

    time kubectl exec -i $pod $container -- sh -c 'mkdir -p /tmp/kheaders-$(uname -r) && cd /tmp/kheaders-$(uname -r) && tar -xJf -' </sys/kernel/kheaders.tar.xz &
    time kubectl exec -i $pod $container -- sh -c 'mkdir -p /tmp/bin && cat >/tmp/bin/bpftrace && chmod +x /tmp/bin/bpftrace' <~/bin/bpftrace &
  done

  wait
}

eks_run_terminal_shell() {
  local pod="$1"
  local container="${2---}"
  shift
  [[ $# -gt 0 ]] && shift

  [[ "$container" == "--" ]] && container=""
  [[ -n "$container" ]] && pod+=" -c"

  kubectl exec -ti $pod $container -- sh -lc '$@' -- "$@"
}

eks_bpftrace_stdin_script() {
  local pod="$1"
  local container="${2---}"
  shift
  [[ $# -gt 0 ]] && shift
  [[ "$container" == "--" ]] && container=""
  [[ -n "$container" ]] && pod+=" -c"

  local e="sed"
  while [[ $# -gt 1 ]]; do
    e+=" -e 's!$1!$2!g'"
    shift
    shift
  done

  eval "$e" | kubectl exec -ti $pod $container -- /tmp/bin/bpftrace -
}

eks_screen_shell_filter() {
  local FILTER="$1"
  local container="${2---}"
  shift
  [[ $# -gt 0 ]] && shift
  [[ "$container" == "--" ]] && container=""

  for pod in $(eks_list_pods_filter "$FILTER"); do
    [[ -n "$container" ]] && pod+=" -c"
    screen -X screen "$SHELL" -c \
      ". ~/.eksrc; . ~/.bcsrc; _bcs_title $pod $container; kubectl exec -ti $pod $container -- sh -lc '\"\$@\"'" -- "$@"
  done
}

function eks_batch_shell_filter() {
  local FILTER="${1-}"
  shift
  local container="${2---}"
  [[ $# -gt 0 ]] && shift
  [[ "$container" == "--" ]] && container="" || container="-c $container"

  if [[ -t 1 ]]; then
    # ANSI color indexes: black = 0, red = 1, green = 2
    # setaf = Set ANSI foreground
    # setab =  "   "   background
    # sgr0  = reset local color adjustments back to default terminal settings
    local errstr="$(tput bold)$(tput setaf 1)$(tput setab 0)error$(tput sgr0)"
    local prefix="$(tput bold)$(tput setaf 2){}$(tput sgr0)"
  else
    local errstr="error"
    local prefix="{}"
  fi

  eks_list_pods_filter "$FILTER" | xargs -P $EKS_BATCH -i kubectl exec -i {} $container \
    sh -lc '"(eval \"\$0\" \
      || echo \"'"$errstr"':\" \"(\"\$0\")\" failed with status code \$?) 2>&1 \
        | while read -r line; do echo \"'"$prefix"':\" \$line; done"' \""$@"\"
}

_eks_cluster_completion_zsh() {
  local state

  _arguments '1: :->eks_cluster'

  case $state in
    eks_cluster)
      _arguments "1:eks_cluster:($_eks_clusters)"
      ;;
  esac
}

_eks_pod_completion_zsh() {
  local state

  _arguments '1: :->eks_pod'

  case $state in
    eks_pod)
      _arguments "1:eks_pod:($_eks_pods)"
      ;;
  esac

}

if [[ "$(basename "$SHELL")" == "zsh" ]]; then
  compdef _eks_cluster_completion_zsh eks_list_clusters_filter
  compdef _eks_cluster_completion_zsh eks_update_kubeconfig
  compdef _eks_pod_completion_zsh eks_list_pods_filter
  compdef _eks_pod_completion_zsh eks_ship_tools_filter_bg
  compdef _eks_pod_completion_zsh eks_send_bpftrace_kheaders_filter_bg
  compdef _eks_pod_completion_zsh eks_bpftrace_stdin_script
  compdef _eks_pod_completion_zsh eks_run_terminal_shell
  compdef _eks_pod_completion_zsh eks_screen_shell_filter
  compdef _eks_pod_completion_zsh eks_batch_shell_filter
else
  complete -W '${_eks_clusters[@]}' eks_list_clusters_filter
  complete -W '${_eks_clusters[@]}' eks_update_kubeconfig
  complete -W '${_eks_pods[@]}' eks_list_pods_filter
  complete -W '${_eks_pods[@]}' eks_ship_tools_filter_bg
  complete -W '${_eks_pods[@]}' eks_send_bpftrace_kheaders_filter_bg
  complete -W '${_eks_pods[@]}' eks_bpftrace_stdin_script
  complete -W '${_eks_pods[@]}' eks_run_terminal_shell
  complete -W '${_eks_pods[@]}' eks_screen_shell_filter
  complete -W '${_eks_pods[@]}' eks_batch_shell_filter
fi

_eks_load_clusters >/dev/null 2>&1
_eks_load_pods >/dev/null 2>&1
